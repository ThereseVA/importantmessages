{
  "definition": {
    "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {},
    "triggers": {
      "When_a_new_email_arrives_(V3)": {
        "type": "ApiConnectionWebhook",
        "inputs": {
          "host": {
            "connection": {
              "name": "@parameters('$connections')['outlook']['connectionId']"
            }
          },
          "body": {
            "NotificationUrl": "@{listCallbackUrl()}"
          },
          "path": "/MailSubscriptionPoke/$subscriptions"
        },
        "conditions": [
          {
            "expression": "@equals(triggerBody()?['importance'], 'High')"
          }
        ]
      }
    },
    "actions": {
      "Create_item": {
        "type": "ApiConnection",
        "inputs": {
          "host": {
            "connection": {
              "name": "@parameters('$connections')['sharepointonline']['connectionId']"
            }
          },
          "method": "post",
          "body": {
            "Title": "@triggerBody()?['subject']",
            "MessageContent": "@triggerBody()?['bodyPreview']",
            "Priority": "High",
            "ExpiryDate": "@addDays(utcNow(), 7)",
            "TargetAudience": "@join(triggerBody()?['toRecipients'], '; ')",
            "Source": "Outlook"
          },
          "path": "/datasets/@{encodeURIComponent(encodeURIComponent('https://gustafkliniken.sharepoint.com/sites/Gustafkliniken'))}/tables/@{encodeURIComponent(encodeURIComponent('Important Messages'))}/items"
        },
        "runAfter": {}
      },
      "Condition": {
        "type": "If",
        "expression": {
          "and": [
            {
              "or": [
                {
                  "contains": [
                    "@triggerBody()?['subject']",
                    "[IMPORTANT]"
                  ]
                },
                {
                  "equals": [
                    "@triggerBody()?['importance']",
                    "High"
                  ]
                }
              ]
            }
          ]
        },
        "actions": {
          "Post_adaptive_card_in_a_chat_or_channel": {
            "type": "ApiConnection",
            "inputs": {
              "host": {
                "connection": {
                  "name": "@parameters('$connections')['teams']['connectionId']"
                }
              },
              "method": "post",
              "body": {
                "recipient": {
                  "channelId": "19:general@thread.teams.microsoft.com"
                },
                "messageBody": {
                  "contentType": "application/vnd.microsoft.card.adaptive",
                  "content": {
                    "type": "AdaptiveCard",
                    "version": "1.3",
                    "body": [
                      {
                        "type": "TextBlock",
                        "text": "ðŸ“§ Important Email Alert",
                        "weight": "Bolder",
                        "size": "Large",
                        "color": "Attention"
                      },
                      {
                        "type": "TextBlock",
                        "text": "@{triggerBody()?['subject']}",
                        "weight": "Bolder",
                        "wrap": true
                      },
                      {
                        "type": "TextBlock",
                        "text": "@{triggerBody()?['bodyPreview']}",
                        "wrap": true,
                        "maxLines": 3
                      },
                      {
                        "type": "FactSet",
                        "facts": [
                          {
                            "title": "From:",
                            "value": "@{triggerBody()?['from']?['emailAddress']?['name']}"
                          },
                          {
                            "title": "Priority:",
                            "value": "@{triggerBody()?['importance']}"
                          },
                          {
                            "title": "Added to Dashboard:",
                            "value": "@{utcNow()}"
                          }
                        ]
                      }
                    ],
                    "actions": [
                      {
                        "type": "Action.OpenUrl",
                        "title": "âœ… Mark as Read",
                        "url": "https://gustafkliniken.sharepoint.com/sites/Gustafkliniken/SitePages/ManagerDashboard.aspx"
                      },
                      {
                        "type": "Action.OpenUrl",
                        "title": "ðŸ“Š View Dashboard",
                        "url": "https://gustafkliniken.sharepoint.com/sites/Gustafkliniken/SitePages/ManagerDashboard.aspx"
                      }
                    ]
                  }
                }
              },
              "path": "/v1.0/teams/@{encodeURIComponent('your-team-id')}/channels/@{encodeURIComponent('your-channel-id')}/messages"
            }
          }
        },
        "runAfter": {
          "Create_item": [
            "Succeeded"
          ]
        }
      }
    }
  },
  "parameters": {
    "$connections": {
      "value": {
        "outlook": {
          "connectionId": "/subscriptions/{subscription-id}/resourceGroups/{resource-group}/providers/Microsoft.Web/connections/outlook",
          "connectionName": "outlook",
          "id": "/subscriptions/{subscription-id}/providers/Microsoft.Web/locations/{location}/managedApis/outlook"
        },
        "sharepointonline": {
          "connectionId": "/subscriptions/{subscription-id}/resourceGroups/{resource-group}/providers/Microsoft.Web/connections/sharepointonline",
          "connectionName": "sharepointonline",
          "id": "/subscriptions/{subscription-id}/providers/Microsoft.Web/locations/{location}/managedApis/sharepointonline"
        },
        "teams": {
          "connectionId": "/subscriptions/{subscription-id}/resourceGroups/{resource-group}/providers/Microsoft.Web/connections/teams",
          "connectionName": "teams",
          "id": "/subscriptions/{subscription-id}/providers/Microsoft.Web/locations/{location}/managedApis/teams"
        }
      }
    }
  }
}
